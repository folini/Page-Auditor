// ----------------------------------------------------------------------------
// Â© 2021 - Franco Folini
// ----------------------------------------------------------------------------
import "./logos/Logo_256x256.png"
import "./logos/Logo_128x128.png"
import "./logos/JSON-LD_100x100.png"
import "./logos/ERROR_100x100.png"
import "./logos/WARNING_100x100.png"
import "./logos/DoubleClick_100x100.png"
import "./logos/GoogleAds_100x100.png"
import "./logos/GoogleTagManager_100x100.png"
import "./logos/FacebookPixel_100x100.png"
import "./logos/TwitterAds_100x100.png"
import "./logos/TwitterAnalytics_100x100.png"
import "./logos/LinkedInAds_100x100.png"
import "./logos/BingAds_100x100.png"
import "./logos/Pinterest_100x100.png"
import "./logos/GoogleAnalyticsV3_100x100.png"
import "./logos/Podsights_100x100.png"
import "./logos/SiteImprove_100x100.png"
import "./logos/Google_100x100.png"
import "./logos/WebStat_100x100.png"
import "./logos/ReplayApp_100x100.png"
import "./logos/CartKit_100x100.png"
import "./logos/Heroku_100x100.png"
import "./logos/Hubspot_100x100.png"
import "./logos/KruxPixel_100x100.png"
import "./logos/AmazonAds_100x100.png"
import "./logos/SegmentAnalytics_100x100.png"
import "./logos/TurnerAnalytics_100x100.png"
import "./logos/Criteo_100x100.png"
import "./logos/Zeta_100x100.png"
import "./logos/QuantCast_100x100.png"
import "./logos/AdForm_100x100.png"
import "./logos/Nativo_100x100.png"
import "./logos/Drift_100x100.png"
import "./logos/NeodataGroup_100x100.png"
import "./logos/Sophus3_100x100.png"
import "./logos/Drip_100x100.png"
import "./logos/CrazyEgg_100x100.png"
import "./logos/LeadFeeder_100x100.png"
import "./logos/OutBrain_100x100.png"
import "./logos/Qualtric_100x100.png"
import "./logos/AvantLink_100x100.png"
import "./logos/ChannelAdvisor_100x100.png"
import "./logos/ScoreCard_100x100.png"
import "./logos/Taboola_100x100.png"
import "./logos/Nielsen_100x100.png"
import "./logos/Webtrekk_100x100.png"
import "./logos/Iubenda_100x100.png"
import "./logos/Cxense_100x100.png"
import "./logos/Cookielaw_100x100.png"
import "./logos/FC_100x100.png"
import "./logos/FC_White_100x100.png"
import "./logos/Medium_100x100.png"
import "./logos/Wordpress_100x100.png"
import "./logos/Git_100x100.png"
import "./logos/Gmail_100x100.png"
import "./logos/Avatar_200x200.png"
import "./logos/Tag_100x100.png"
import "./logos/OpenGraph_100x100.png"
import "./logos/Swiftype_100x100.png"
import "./logos/REP_100x100.png"
import "./logos/Lock_100x100.png"
import "./logos/SEO_100x100.png"
import "./logos/Windows_100x100.png"
import "./logos/Chromium_100x100.png"
import "./logos/Apple_100x100.png"
import "./logos/Shopify_100x100.png"
import "./logos/Branch_100x100.png"
import "./logos/IE_100x100.png"
import "./logos/MS_100x100.png"
import "./logos/Unclassified_100x100.png"
import "./logos/Xandr_100x100.png"
import "./logos/IAS_100x100.png"
import "./logos/Wunderkind_100x100.png"
import "./logos/Heap_100x100.png"
import "./logos/Marketo_100x100.png"
import "./logos/VWO_100x100.png"
import "./logos/Cookiebot_100x100.png"
import "./logos/Pardot_100x100.png"
import "./logos/AdRoll_100x100.png"
import "./logos/Quora_100x100.png"
import "./logos/Hotjar_100x100.png"
import "./logos/Trustpilot_100x100.png"
import "./logos/LivePerson_100x100.png"
import "./logos/Reddit_100x100.png"
import "./logos/BuySellAds_100x100.png"
import "./logos/CloudFlare_100x100.png"
import "./logos/GoogleOptimize_100x100.png"
import "./logos/Firebase_100x100.png"
import "./logos/Wordpress_100x100.png"
import "./logos/Riskified_100x100.png"
import "./logos/Onetrust_100x100.png"
import "./logos/Amplitude_100x100.png"
import "./logos/NewRelic_100x100.png"
import "./logos/Squarespace_100x100.png"
import "./logos/Stripe_100x100.png"
import "./logos/AppsFlyer_100x100.png"
import "./logos/Appcues_100x100.png"
import "./logos/BrandMetrics_100x100.png"
import "./logos/Parrable_100x100.png"
import "./logos/Neustar_100x100.png"
import "./logos/TheTradeDesk_100x100.png"
import "./logos/TIDIO_100x100.png"
import "./logos/jQuery_100x100.png"
import "./logos/Tapfiliate_100x100.png"
import "./logos/Intercom_100x100.png"
import "./logos/Clearbit_100x100.png"
import "./logos/Chartbeat_100x100.png"
import "./logos/Onetag_100x100.png"
import "./logos/InsurAds_100x100.png"
import "./logos/UserZoom_100x100.png"
import "./logos/Consensu_100x100.png"
import "./logos/Adobe_100x100.png"
import "./logos/TikTok_100x100.png"
import "./logos/YouTube_100x100.png"
import "./logos/SnapChat_100x100.png"
import "./logos/ContentSquare_100x100.png"
import "./logos/USER1st_100x100.png"
import "./logos/FontAwesome_100x100.png"
import "./logos/Cloudfront_100x100.png"
import "./logos/AWS_100x100.png"
import "./logos/JS_100x100.png"
import "./logos/Mailchimp_100x100.png"
import "./logos/Yahoo_100x100.png"
import "./logos/Jivox_100x100.png"
import "./logos/LeadLander_100x100.png"
import "./logos/Fastly_100x100.png"
import "./logos/Demandbase_100x100.png"
import "./logos/AdLightning_100x100.png"
import "./logos/Mather_100x100.png"
import "./logos/Lytics_100x100.png"
import "./logos/Sitemap_100x100.png"
import "./logos/MOAT_100x100.png"
import "./logos/RichAudience_100x100.png"
import "./logos/Gladly_100x100.png"
import "./logos/Tealium_100x100.png"
import "./logos/Algonomy_100x100.png"
import "./logos/Teads_100x100.png"
import "./logos/SalesForce_100x100.png"
import "./logos/Lotame_100x100.png"
import "./logos/MovableInk_100x100.png"
import "./logos/Skai_100x100.png"
import "./logos/Zync_100x100.png"
import "./logos/Bombora_100x100.png"

import "./default.htm"
import "./manifest.json"

import {Card} from "./card"
import * as JsonLd from "./sections/jsonld"
import * as Scripts from "./sections/scripts"
import * as Credits from "./sections/credits"
import * as Meta from "./sections/meta"
import * as Intro from "./sections/intro"
import * as Robots from "./sections/robots"

export type sectionActions = {
  injector: undefined | (() => any)
  reporter: (url: string | undefined, data: any) => Promise<string>
  eventManager: undefined | (() => void)
}

type sectionType = {
  tabId: string
  name: string
  reportId: string
  actions: sectionActions
}

const sections: sectionType[] = [
  {
    tabId: "id-intro",
    name: "Intro",
    reportId: "id-report-intro",
    actions: Intro.actions,
  },
  {
    tabId: "id-meta",
    name: "Meta<br/>Tags",
    reportId: "id-report-meta",
    actions: Meta.actions,
  },
  {
    tabId: "id-jsonld",
    name: "Structured<br/>Data",
    reportId: "id-report-jsonld",
    actions: JsonLd.actions,
  },
  {
    tabId: "id-scripts",
    name: "JavaScript<br/>Code",
    reportId: "id-report-scripts",
    actions: Scripts.actions,
  },
  {
    tabId: "id-robots",
    name: "Robots<br/>Sitemaps",
    reportId: "id-report-robots",
    actions: Robots.actions,
  },
  {
    tabId: "id-credits",
    name: "Credits",
    reportId: "id-report-credits",
    actions: Credits.actions,
  },
]

async function action(section: sectionType, actions: sectionActions) {
  var report: string = ""
  const [tab] = await chrome.tabs.query({active: true, currentWindow: true})
  inject: try {
    if (actions.injector === undefined) {
      report = await actions.reporter(tab.url, undefined)
      break inject
    }

    let res = await chrome.scripting.executeScript({
      target: {tabId: tab.id} as chrome.scripting.InjectionTarget,
      function: actions.injector,
    })
    report = await actions.reporter(tab.url, res[0].result)
  } catch (err: any) {
    const emptyTab = `Cannot access a chrome:// URL`
    const emptyTabMsg = `PageAuditor can not run on empty or internal Chrome tabs.<br/><br/>Please launch <b>Page Auditor for Technical SEO</b> on a regular web page.`
    report = new Card()
      .error((err as Error).message === emptyTab ? emptyTabMsg : err.message)
      .render()
  }
  document.getElementById(section.reportId)!.innerHTML = report

  if (actions.eventManager !== undefined) {
    actions.eventManager()
  }
}

const activateSection = (activeSec: sectionType) => {
  sections.forEach(sec => {
    document.getElementById(sec.tabId)!.classList.remove("active")
    document.getElementById(sec.reportId)!.classList.remove("show")
  })
  document.getElementById(activeSec.tabId)?.classList.add("active")
  document.getElementById(activeSec.reportId)?.classList.add("show")
  action(activeSec, activeSec.actions)
}

document.addEventListener("DOMContentLoaded", () => {
  const tabsContainer = document.getElementById("id-tabs") as HTMLUListElement
  const reportContainer = document.getElementById("id-report-outer-container") as HTMLDivElement
  sections.forEach((section, i) => {
    const sep = document.createElement("li")
      sep.className = i === 0 ? "gap-mini" : "gap-sep"
      tabsContainer.append(sep)
    const tab = document.createElement("li")
      tab.id = section.tabId
      tab.innerHTML = section.name
      tab.addEventListener("click", () => 
        activateSection(section)
      )
      tabsContainer.append(tab)
    const report = document.createElement('div')
      report.id = section.reportId
      report.className = 'inner-report-container'
      reportContainer.append(report)
  })
  activateSection(sections[0])
})
